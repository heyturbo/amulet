<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水符/火符收益计算器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #ef4444;
            --border-color: #e5e7eb;
            --bg-light: #f9fafb;
            --bg-dark: #f3f4f6;
            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --text-light: #6b7280;
            --shadow: rgba(0, 0, 0, 0.1) 0px 1px 3px 0px, rgba(0, 0, 0, 0.06) 0px 1px 2px 0px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--text-dark);
            line-height: 1.5;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 10px;
        }
        
        h1, h2, h3, h4 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        h1 {
            font-size: 1.5rem;
            text-align: center;
            margin: 15px 0;
            color: var(--text-dark);
        }
        
        h2 {
            font-size: 1.25rem;
            margin-top: 20px;
        }
        
        h3 {
            font-size: 1.125rem;
            margin-top: 15px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .grid {
            display: grid;
            gap: 15px;
        }
        
        .grid-2 {
            grid-template-columns: 1fr;
        }
        
        .grid-4 {
            grid-template-columns: 1fr 1fr;
        }
        
        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .grid-4 {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-medium);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .result-box {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .result-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-medium);
        }
        
        .result-value {
            font-size: 1.25rem;
            font-weight: 500;
            margin-top: 3px;
        }
        
        .result-hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 3px;
        }
        
        .pattern-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .pattern-item {
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin: 15px 0;
        }
        
        .fire-color {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .water-color {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .conclusion-list {
            padding-left: 20px;
        }
        
        .conclusion-list li {
            margin-bottom: 5px;
        }
        
        .conclusion-list strong {
            font-weight: 500;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 模式切换按钮样式 */
        .mode-switcher {
            display: flex;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-light);
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .mode-btn:first-child {
            border-right: 1px solid var(--border-color);
        }
        
        /* 伤害波动提示样式 */
        .damage-range {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 5px;
            font-style: italic;
        }
        
        @media (max-width: 480px) {
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.25rem;
            }
            
            .card {
                padding: 12px;
            }
            
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>水符/火符收益计算器</h1>
        
        <!-- 模式切换 -->
        <div class="mode-switcher">
            <div class="mode-btn active" data-mode="monster">野怪模式</div>
            <div class="mode-btn" data-mode="pk">PK模式</div>
        </div>
        
        <!-- 控制面板 -->
        <div class="card">
            <div class="grid grid-2">
                <!-- 基础参数 -->
                <div>
                    <h3>基础参数</h3>
                    <div class="form-group">
                        <label for="attackPower">攻击力:</label>
                        <input type="text" id="attackPower" value="300,000">
                    </div>
                    
                    <div class="form-group">
                        <label for="skillCoefficient">技能系数:</label>
                        <input type="number" id="skillCoefficient" min="0.1" max="10" step="0.1" value="1.0">
                    </div>
                    
                    <div class="form-group">
                        <label for="totalRounds">战斗回合数:</label>
                        <input type="number" id="totalRounds" min="1" max="30" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="enemyHP">敌人血量:</label>
                        <input type="text" id="enemyHP" value="15,000,000">
                    </div>
                    
                    <!-- PK模式专用参数 -->
                    <div id="pkModeParams" class="form-group" style="display: none;">
                        <label for="damageReduction">减伤系数 (%):</label>
                        <input type="number" id="damageReduction" min="0" max="90" step="1" value="50">
                        <div class="damage-range">
                            伤害波动范围: 0.9 ~ 1.1 (默认)
                        </div>
                    </div>
                </div>
                
                <!-- 技能模式 -->
                <div>
                    <h3>技能伤害模式</h3>
                    <div class="form-group">
                        <label for="patternSelect">预设模式:</label>
                        <select id="patternSelect">
                            <option value="均衡伤害">均衡伤害</option>
                            <option value="前期高伤">前期高伤</option>
                            <option value="后期高伤">后期高伤</option>
                            <option value="波动伤害">波动伤害</option>
                            <option value="极前期伤">极前期伤</option>
                            <option value="自定义">自定义</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="customPattern">自定义模式 (用逗号分隔系数):</label>
                        <textarea id="customPattern" rows="3" placeholder="例如: 1.5, 1.2, 0.8, 0.5"></textarea>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-label">当前模式预览:</div>
                        <div id="patternPreview" class="pattern-preview"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 计算结果 -->
        <div class="card">
            <h3>计算结果</h3>
            <div class="grid grid-4">
                <div class="result-box">
                    <div class="result-label">临界血量</div>
                    <div id="criticalHP" class="result-value">4,500,000</div>
                    <div id="criticalHPMillions" class="result-hint">4.50百万</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">半血回合</div>
                    <div id="halfHpRound" class="result-value">3 / 10</div>
                    <div class="result-hint">达到敌人半血所需回合数</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">火符总收益</div>
                    <div id="fireBenefit" class="result-value">180,000</div>
                    <div class="result-hint">敌人半血前20%伤害加成</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">水符总收益</div>
                    <div id="waterBenefit" class="result-value">450,000</div>
                    <div class="result-hint">全程15%概率再次释放</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">收益比(火/水)</div>
                    <div id="benefitRatio" class="result-value">0.400</div>
                    <div id="ratioHint" class="result-hint">水符收益更高</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">推荐选择</div>
                    <div id="bestChoice" class="result-value water-color">水符</div>
                    <div id="comparisonResult" class="result-hint">选择水符更优</div>
                </div>
            </div>
        </div>
        
        <!-- 图表分析 -->
        <div class="card">
            <div class="tab-container">
                <div class="tab active" data-tab="hpChart">敌人血量影响</div>
                <div class="tab" data-tab="attackChart">攻击力影响</div>
                <div id="reductionTabItem" class="tab" data-tab="reductionChart" style="display: none;">减伤系数影响</div>
            </div>
            
            <div id="hpChart" class="tab-content active">
                <div class="chart-container">
                    <canvas id="hpChartCanvas"></canvas>
                </div>
            </div>
            
            <div id="attackChart" class="tab-content">
                <div class="chart-container">
                    <canvas id="attackChartCanvas"></canvas>
                </div>
            </div>
            
            <div id="reductionChart" class="tab-content">
                <div class="chart-container">
                    <canvas id="reductionChartCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 结论 -->
        <div class="card">
            <h3>实用结论</h3>
            <div id="monsterConclusion">
                <ul class="conclusion-list">
                    <li><strong>临界值公式:</strong> 敌人血量 = 攻击力 × 技能系数 × 1.5 × 回合数</li>
                    <li><strong>当敌人血量 &lt; 临界值时:</strong> 水符更优 (15%的持续收益)</li>
                    <li><strong>当敌人血量 &gt; 临界值时:</strong> 火符更优 (敌人长时间保持在半血以上)</li>
                    <li><strong>技能伤害分布影响:</strong> 前期高伤害分布更有利于火符，后期高伤害分布更有利于水符</li>
                    <li><strong>实战选择:</strong> 对抗小怪群通常选择水符，对抗高血量BOSS通常选择火符</li>
                </ul>
            </div>
            
            <div id="pkConclusion" style="display: none;">
                <ul class="conclusion-list">
                    <li><strong>PK临界值公式:</strong> 敌人有效血量 = 实际血量 ÷ (1 - 减伤系数)</li>
                    <li><strong>减伤系数影响:</strong> 减伤越高，火符优势越明显（敌人实际血量变厚）</li>
                    <li><strong>战斗节奏:</strong> PK战斗中选择火符通常更优，因减伤效果延长了敌人半血之前的时间</li>
                    <li><strong>波动伤害:</strong> 伤害波动会使战斗更加不可预测，整体收益比计算基于平均值</li>
                    <li><strong>实战选择:</strong> 高减伤战斗选择火符，快速击杀战斗选择水符</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 数据模型
        const model = {
            // 基本参数
            attackPower: 300000,
            skillCoefficient: 1.0,
            totalRounds: 10,
            enemyHP: 15000000,
            selectedPattern: "均衡伤害",
            customPattern: "",
            
            // 模式设置
            gameMode: "monster", // monster 或 pk
            damageReduction: 50, // 百分比，默认50%
            damageRangeMin: 0.9,
            damageRangeMax: 1.1,
            
            // 技能模式预设
            skillPatterns: {
                "均衡伤害": Array(10).fill(1.0),
                "前期高伤": [1.5, 1.5, 1.5, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75],
                "后期高伤": [0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 1.5, 1.5, 1.5],
                "波动伤害": [1.1, 0.9, 1.1, 0.9, 1.0, 0.0, 1.1, 0.1, 0.9, 0.9],
                "极前期伤": [2.0, 2.0, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5]
            },
            
            // 获取当前使用的技能模式
            getCurrentPattern() {
                if (this.selectedPattern === "自定义") {
                    try {
                        const parsed = this.customPattern.split(',').map(num => parseFloat(num.trim()));
                        if (parsed.length > 0 && !parsed.some(isNaN)) {
                            return parsed;
                        }
                    } catch (e) {
                        return this.skillPatterns["均衡伤害"];
                    }
                }
                return this.skillPatterns[this.selectedPattern] || this.skillPatterns["均衡伤害"];
            },
            
            // 获取实际有效血量（考虑减伤）
            getEffectiveHP() {
                if (this.gameMode === "pk") {
                    // 减伤影响：实际血量 / (1 - 减伤系数)
                    return this.enemyHP / (1 - this.damageReduction / 100);
                }
                return this.enemyHP;
            },
            
            // 计算平均伤害（考虑波动）
            getAverageDamage(baseDamage) {
                if (this.gameMode === "pk") {
                    // 计算波动后的平均伤害
                    const minDamage = baseDamage * this.damageRangeMin;
                    const maxDamage = baseDamage * this.damageRangeMax;
                    const avgDamage = (minDamage + maxDamage) / 2;
                    
                    // 应用减伤
                    return avgDamage * (1 - this.damageReduction / 100);
                }
                return baseDamage;
            },
            
            // 计算临界血量
            calculateCriticalHP() {
                const effectiveAttack = this.attackPower * this.skillCoefficient;
                // 基础临界公式
                let criticalHP = effectiveAttack * 1.5 * this.totalRounds;
                
                // PK模式需要考虑减伤
                if (this.gameMode === "pk") {
                    const effectiveDamage = this.getAverageDamage(effectiveAttack);
                    criticalHP = effectiveDamage * 1.5 * this.totalRounds;
                }
                
                return criticalHP;
            },
            
            // 计算效益比
            calculateBenefitRatio() {
                const effectiveAttack = this.attackPower * this.skillCoefficient;
                const pattern = this.getCurrentPattern().slice(0, this.totalRounds);
                
                // 如果模式长度不足，填充到足够长度
                while (pattern.length < this.totalRounds) {
                    pattern.push(1.0);
                }
                
                // 计算实际伤害序列（考虑减伤和波动）
                const damages = pattern.map(p => {
                    const baseDamage = effectiveAttack * p;
                    return this.getAverageDamage(baseDamage);
                });
                
                // 计算累积伤害和达到半血的回合
                let cumulativeDamage = 0;
                let halfHpRound = this.totalRounds;
                const effectiveHP = this.getEffectiveHP();
                
                for (let i = 0; i < damages.length; i++) {
                    cumulativeDamage += damages[i];
                    if (cumulativeDamage >= effectiveHP / 2) {
                        halfHpRound = i + 1;
                        break;
                    }
                }
                
                // 计算火符和水符收益
                const fireBenefit = 0.2 * damages.slice(0, halfHpRound).reduce((a, b) => a + b, 0);
                const waterBenefit = 0.15 * damages.reduce((a, b) => a + b, 0);
                const ratio = fireBenefit / waterBenefit;
                
                return {
                    fireBenefit,
                    waterBenefit,
                    ratio,
                    halfHpRound,
                    bestChoice: ratio > 1 ? "火符" : "水符"
                };
            },
            
            // 临界血量与当前敌人血量的比较结果
            getCriticalComparison() {
                const criticalHP = this.calculateCriticalHP();
                const effectiveHP = this.getEffectiveHP();
                
                if (Math.abs(effectiveHP - criticalHP) / criticalHP < 0.05) {
                    return "接近临界值";
                }
                return effectiveHP > criticalHP ? "选择火符更优" : "选择水符更优";
            },
            
            // 生成基于血量的收益比数据
            generateHpBasedData() {
                const effectiveAttack = this.attackPower * this.skillCoefficient;
                const data = [];
                
                // 生成从敌人血量20%到200%的范围
                const baseHP = this.enemyHP;
                const minHP = baseHP * 0.2;
                const maxHP = baseHP * 2;
                const steps = 40;
                const step = (maxHP - minHP) / steps;
                
                for (let i = 0; i <= steps; i++) {
                    const hp = minHP + i * step;
                    // 暂存当前血量
                    const originalHP = this.enemyHP;
                    // 设置新血量进行计算
                    this.enemyHP = hp;
                    
                    // 使用当前选择的技能模式计算
                    const results = this.calculateBenefitRatio();
                    
                    // 恢复原血量
                    this.enemyHP = originalHP;
                    
                    data.push({
                        hp: hp,
                        hpMillions: (hp / 1000000).toFixed(2),
                        benefitRatio: results.ratio,
                        bestChoice: results.bestChoice
                    });
                }
                
                return data;
            },
            
            // 生成基于攻击力的收益比数据
            generateAttackBasedData() {
                const data = [];
                const baseAttack = this.attackPower;
                const minAttack = baseAttack * 0.2;
                const maxAttack = baseAttack * 2;
                const steps = 40;
                const step = (maxAttack - minAttack) / steps;
                
                for (let i = 0; i <= steps; i++) {
                    const atk = minAttack + i * step;
                    // 暂存当前攻击力
                    const originalAttack = this.attackPower;
                    // 设置新攻击力进行计算
                    this.attackPower = atk;
                    
                    // 计算新结果
                    const results = this.calculateBenefitRatio();
                    
                    // 恢复原攻击力
                    this.attackPower = originalAttack;
                    
                    data.push({
                        attack: atk,
                        attackK: (atk / 10000).toFixed(1),
                        benefitRatio: results.ratio,
                        bestChoice: results.bestChoice
                    });
                }
                
                return data;
            },
            
            // 生成基于减伤系数的收益比数据（仅PK模式）
            generateReductionBasedData() {
                if (this.gameMode !== "pk") return [];
                
                const data = [];
                const minReduction = 0;
                const maxReduction = 90;
                const steps = 40;
                const step = (maxReduction - minReduction) / steps;
                
                for (let i = 0; i <= steps; i++) {
                    const reduction = minReduction + i * step;
                    // 暂存当前减伤
                    const originalReduction = this.damageReduction;
                    // 设置新减伤进行计算
                    this.damageReduction = reduction;
                    
                    // 计算新结果
                    const results = this.calculateBenefitRatio();
                    
                    // 恢复原减伤
                    this.damageReduction = originalReduction;
                    
                    data.push({
                        reduction: reduction,
                        benefitRatio: results.ratio,
                        bestChoice: results.bestChoice
                    });
                }
                
                return data;
            },
            
            // 切换游戏模式并设置相应默认值
            switchGameMode(mode) {
                this.gameMode = mode;
                
                if (mode === "pk") {
                    // 切换到PK模式的默认值
                    this.enemyHP = 1000000; // 100万
                    this.damageReduction = 50; // 50%
                    this.selectedPattern = "波动伤害"; // 波动伤害模式
                } else {
                    // 切换回野怪模式的默认值
                    this.enemyHP = 15000000; // 1500万
                    // 保持当前的模式和其他设置
                }
            }
        };
        
        // UI控制器
        const controller = {
            init() {
                this.bindElements();
                this.bindEvents();
                this.updateUI();
                this.initCharts();
            },
            
            bindElements() {
                // 模式切换按钮
                this.modeBtns = document.querySelectorAll('.mode-btn');
                
                // 输入元素
                this.attackPowerInput = document.getElementById('attackPower');
                this.skillCoefficientInput = document.getElementById('skillCoefficient');
                this.totalRoundsInput = document.getElementById('totalRounds');
                this.enemyHPInput = document.getElementById('enemyHP');
                this.damageReductionInput = document.getElementById('damageReduction');
                this.pkModeParams = document.getElementById('pkModeParams');
                this.patternSelect = document.getElementById('patternSelect');
                this.customPatternInput = document.getElementById('customPattern');
                
                // 结论显示
                this.monsterConclusion = document.getElementById('monsterConclusion');
                this.pkConclusion = document.getElementById('pkConclusion');
                
                // 输出元素
                this.patternPreview = document.getElementById('patternPreview');
                this.criticalHPOutput = document.getElementById('criticalHP');
                this.criticalHPMillionsOutput = document.getElementById('criticalHPMillions');
                this.halfHpRoundOutput = document.getElementById('halfHpRound');
                this.fireBenefitOutput = document.getElementById('fireBenefit');
                this.waterBenefitOutput = document.getElementById('waterBenefit');
                this.benefitRatioOutput = document.getElementById('benefitRatio');
                this.ratioHintOutput = document.getElementById('ratioHint');
                this.bestChoiceOutput = document.getElementById('bestChoice');
                this.comparisonResultOutput = document.getElementById('comparisonResult');
                
                // 图表
                this.hpChartCanvas = document.getElementById('hpChartCanvas');
                this.attackChartCanvas = document.getElementById('attackChartCanvas');
                this.reductionChartCanvas = document.getElementById('reductionChartCanvas');
                this.reductionTabItem = document.getElementById('reductionTabItem');
                
                // 标签页
                this.tabs = document.querySelectorAll('.tab');
                this.tabContents = document.querySelectorAll('.tab-content');
            },
            
            bindEvents() {
                // 模式切换事件
                this.modeBtns.forEach(btn => {
                    btn.addEventListener('click', this.handleModeChange.bind(this));
                });
                
                // 输入事件
                this.attackPowerInput.addEventListener('input', this.handleAttackPowerChange.bind(this));
                this.skillCoefficientInput.addEventListener('input', this.handleSkillCoefficientChange.bind(this));
                this.totalRoundsInput.addEventListener('input', this.handleTotalRoundsChange.bind(this));
                this.enemyHPInput.addEventListener('input', this.handleEnemyHPChange.bind(this));
                this.damageReductionInput.addEventListener('input', this.handleDamageReductionChange.bind(this));
                this.patternSelect.addEventListener('change', this.handlePatternSelectChange.bind(this));
                this.customPatternInput.addEventListener('input', this.handleCustomPatternChange.bind(this));
                
                // 标签页切换
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', this.handleTabClick.bind(this));
                });
            },
            
            handleModeChange(e) {
                const mode = e.target.getAttribute('data-mode');
                
                // 更新UI状态
                this.modeBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // 切换模式
                model.switchGameMode(mode);
                
                // 更新UI
                this.updateModeUI(mode);
                this.updateInputValues();
                this.updateUI();
                this.updateCharts();
            },
            
            // 更新模式相关UI
            updateModeUI(mode) {
                // PK模式参数显示控制
                if (mode === "pk") {
                    this.pkModeParams.style.display = "block";
                    this.reductionTabItem.style.display = "block";
                    this.monsterConclusion.style.display = "none";
                    this.pkConclusion.style.display = "block";
                } else {
                    this.pkModeParams.style.display = "none";
                    this.reductionTabItem.style.display = "none";
                    this.monsterConclusion.style.display = "block";
                    this.pkConclusion.style.display = "none";
                }
            },
            
            // 更新输入框的值
            updateInputValues() {
                this.attackPowerInput.value = this.formatNumber(model.attackPower);
                this.skillCoefficientInput.value = model.skillCoefficient;
                this.totalRoundsInput.value = model.totalRounds;
                this.enemyHPInput.value = this.formatNumber(model.enemyHP);
                this.damageReductionInput.value = model.damageReduction;
                this.patternSelect.value = model.selectedPattern;
                this.customPatternInput.value = model.customPattern;
            },
            
            handleAttackPowerChange(e) {
                model.attackPower = this.parseNumber(e.target.value);
                this.updateUI();
                this.updateCharts();
            },
            
            handleSkillCoefficientChange(e) {
                model.skillCoefficient = parseFloat(e.target.value) || 1.0;
                this.updateUI();
                this.updateCharts();
            },
            
            handleTotalRoundsChange(e) {
                model.totalRounds = parseInt(e.target.value) || 10;
                this.updateUI();
                this.updateCharts();
            },
            
            handleEnemyHPChange(e) {
                model.enemyHP = this.parseNumber(e.target.value);
                this.updateUI();
                this.updateCharts();
            },
            
            handleDamageReductionChange(e) {
                model.damageReduction = parseFloat(e.target.value) || 50;
                this.updateUI();
                this.updateCharts();
            },
            
            handlePatternSelectChange(e) {
                model.selectedPattern = e.target.value;
                if (model.selectedPattern !== "自定义") {
                    this.customPatternInput.value = "";
                    model.customPattern = "";
                }
                this.updateUI();
                this.updateCharts();
            },
            
            handleCustomPatternChange(e) {
                model.customPattern = e.target.value;
                if (model.selectedPattern !== "自定义") {
                    model.selectedPattern = "自定义";
                    this.patternSelect.value = "自定义";
                }
                this.updateUI();
                this.updateCharts();
            },
            
            handleTabClick(e) {
                const tabId = e.target.getAttribute('data-tab');
                
                // 更新标签页状态
                this.tabs.forEach(tab => {
                    tab.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // 更新内容区域
                this.tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            },
            
            updateUI() {
                // 获取计算结果
                const results = model.calculateBenefitRatio();
                const criticalHP = model.calculateCriticalHP();
                
                // 更新模式预览
                this.updatePatternPreview();
                
                // 更新结果数据
                this.criticalHPOutput.textContent = this.formatNumber(Math.round(criticalHP));
                this.criticalHPMillionsOutput.textContent = (criticalHP / 1000000).toFixed(2) + "百万";
                this.halfHpRoundOutput.textContent = `${results.halfHpRound} / ${model.totalRounds}`;
                this.fireBenefitOutput.textContent = this.formatNumber(Math.round(results.fireBenefit));
                this.waterBenefitOutput.textContent = this.formatNumber(Math.round(results.waterBenefit));
                this.benefitRatioOutput.textContent = results.ratio.toFixed(3);
                this.ratioHintOutput.textContent = results.ratio > 1 ? "火符收益更高" : "水符收益更高";
                
                // 更新推荐选择
                this.bestChoiceOutput.textContent = results.bestChoice;
                this.bestChoiceOutput.className = "result-value " + (results.bestChoice === "火符" ? "fire-color" : "water-color");
                this.comparisonResultOutput.textContent = model.getCriticalComparison();
            },
            
            updatePatternPreview() {
                const pattern = model.getCurrentPattern().slice(0, model.totalRounds);
                this.patternPreview.innerHTML = "";
                
                pattern.forEach((value, index) => {
                    const item = document.createElement("span");
                    item.className = "pattern-item";
                    item.textContent = value.toFixed(1);
                    
                    // 设置背景颜色
                    if (value > 1) {
                        item.style.backgroundColor = "#fecaca"; // 红色背景
                    } else if (value < 1) {
                        item.style.backgroundColor = "#bfdbfe"; // 蓝色背景
                    } else {
                        item.style.backgroundColor = "#e5e7eb"; // 灰色背景
                    }
                    
                    this.patternPreview.appendChild(item);
                });
            },
            
            // 初始化图表
            initCharts() {
                // 血量影响图表
                this.hpChart = new Chart(this.hpChartCanvas, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: '收益比',
                            borderColor: '#8884d8',
                            backgroundColor: 'rgba(136, 132, 216, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw.benefitRatio.toFixed(3);
                                        return `收益比: ${value}`;
                                    },
                                    title: function(context) {
                                        const value = context[0].raw.hpMillions;
                                        return `血量: ${value}百万`;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 1,
                                        yMax: 1,
                                        borderColor: 'red',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        label: {
                                            content: '临界值',
                                            position: 'end'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '敌人血量(百万)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '火符/水符收益比'
                                }
                            }
                        }
                    }
                });
                
                // 攻击力影响图表
                this.attackChart = new Chart(this.attackChartCanvas, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: '收益比',
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw.benefitRatio.toFixed(3);
                                        return `收益比: ${value}`;
                                    },
                                    title: function(context) {
                                        const value = context[0].raw.attackK;
                                        return `攻击力: ${value}万`;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 1,
                                        yMax: 1,
                                        borderColor: 'red',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        label: {
                                            content: '临界值',
                                            position: 'end'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '攻击力(万)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '火符/水符收益比'
                                }
                            }
                        }
                    }
                });
                
                // 减伤系数影响图表（PK模式专用）
                this.reductionChart = new Chart(this.reductionChartCanvas, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: '收益比',
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw.benefitRatio.toFixed(3);
                                        return `收益比: ${value}`;
                                    },
                                    title: function(context) {
                                        const value = context[0].raw.reduction;
                                        return `减伤系数: ${value}%`;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 1,
                                        yMax: 1,
                                        borderColor: 'red',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        label: {
                                            content: '临界值',
                                            position: 'end'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '减伤系数(%)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '火符/水符收益比'
                                }
                            }
                        }
                    }
                });
                
                this.updateCharts();
            },
            
            // 更新图表数据
            updateCharts() {
                // 更新基于血量的图表
                const hpData = model.generateHpBasedData();
                this.hpChart.data.labels = hpData.map(item => item.hpMillions);
                this.hpChart.data.datasets[0].data = hpData.map(item => ({
                    x: item.hpMillions,
                    y: item.benefitRatio,
                    benefitRatio: item.benefitRatio,
                    hpMillions: item.hpMillions
                }));
                this.hpChart.update();
                
                // 更新基于攻击力的图表
                const attackData = model.generateAttackBasedData();
                this.attackChart.data.labels = attackData.map(item => item.attackK);
                this.attackChart.data.datasets[0].data = attackData.map(item => ({
                    x: item.attackK,
                    y: item.benefitRatio,
                    benefitRatio: item.benefitRatio,
                    attackK: item.attackK
                }));
                this.attackChart.update();
                
                // 如果是PK模式，更新减伤系数图表
                if (model.gameMode === "pk") {
                    const reductionData = model.generateReductionBasedData();
                    this.reductionChart.data.labels = reductionData.map(item => item.reduction);
                    this.reductionChart.data.datasets[0].data = reductionData.map(item => ({
                        x: item.reduction,
                        y: item.benefitRatio,
                        benefitRatio: item.benefitRatio,
                        reduction: item.reduction
                    }));
                    this.reductionChart.update();
                }
            },
            
            // 辅助函数: 格式化数字
            formatNumber(value) {
                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            },
            
            // 辅助函数: 解析数字
            parseNumber(value) {
                return parseInt(value.toString().replace(/,/g, "")) || 0;
            }
        };
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            controller.init();
        });
    </script>
</body>
</html>
